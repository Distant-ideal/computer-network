## 多进程

进程是程序在计算机上的一次执行活动。当你运行一个程序,你就启动了一个进程。

### 进程的特性

1.动态性：进程的实质是程序在多道程序系统中的一次执行过程，进程是动态产生，动态消亡的

2.并发性：任何进程都可以同其他进程一起并发执行

3.独立性：进程是一个能独立运行的基本单位，同时也是系统分配资源和调度的独立单位

4.异步性：由于进程间的相互制约，使进程具有执行的间断性，即进程按各自独立的、不可预知的速度向前推进

5.结构特征：进程由程序、数据和进程控制块三部分组成

### 僵尸进程

僵尸进程指的是那些虽然已经终止的进程，但仍然保留一些信息，等待其父进程为其收尸

处理方式：如果一个进程在其终止的时候，自己就回收所有分配给它的资源，系统就不会产生所谓的僵尸进程了

### 运行过程

创建:每个进程都是由其父进程创建进程可以创建子进程，子进程又可以创建子进程的子进程

运行:多个进程可以同时存在进程间可以通信

撤销:进程可以被撤销，从而结束一个进程的运行

### 执行状态

执行状态：进程正在占用CPU

就绪状态：进程已具备一切条件，正在等待分配CPU的处理时间片

等待状态：进程不能使用CPU，若等待事件发生则可将其唤醒

### 函数

Fork会复制父进程所有资源，父子进程完全独立，虽然一个进程可以包含多个线程，但是fork后的子进程是单线程的。

进程是并发执行的程序在执行过程中分配和管理资源的基本单位，是一个动态概念，竟争计算机系统资源的基本单位。每一个进程都有一个自己的地址空间，即进程空间

vfork()函数也用于创建一个进程，返回值与fork()相同。

fork()与vfork()的异同

执行次序： 
fork():对父子进程的调度室由调度器决定的； 
vfork():是先调用子进程，等子进程的exit(1)被调用后，再调用父进程；

对数据段的影响： 
fork():父子进程不共享一段地址空间，修改子进程，父进程的内容并不会受 影响。

vfork():在子进程调用exit之前，它在父进程的空间中运行，也就是说会更改 父进程的数据段、栈和堆。。即共享代码区和数据区，且地址和内容都是一 样的。

fork函数若成功调用一次则返回两个值，子进程返回0，父进程返回子进程标记；否则，出错返回-1。

fork函数中使用exit 进行退出子进程的操作

## 共享内存

进程是一个独立的资源管理单元，不同进程间的资源是独立的，不能在一个进程中访问另一个进程的用户空间和内存空间。但是，进程不是孤立的，不同进程之间需要信息的交互和状态的传递，因此需要进程间数据的传递、同步和异步的机制

共享内存，即在内存中开辟一段特殊的内存空间，多个进程可互斥访问，该内存空间具有自身特有的数据结构

共享内存是在两个正在运行的进程之间共享和传递数据的一种最有效的方式

### shmget

该函数用来创建共享内存

```c
int shmget(key_t key, size_t size, int shmflg);
```

_key：程序需要提供一个参数key（非0整数），它有效地为共享内存段命名

_size:size以字节为单位指定需要共享的内存容量

shmflg：是权限标志，它的作用与open函数的mode参数一样

### shmat

第一次创建完共享内存时，它还不能被任何进程访问，shmat函数的作用就是用来启动对该共享内存的访问，并把共享内存连接到当前进程的地址空间。

```c
void *shmat(int shmid, const void *shmaddr, int shmflg);
```

shm_id：由shmget函数返回的共享内存标识。

shm_addr：指定共享内存连接到当前进程中的地址位置，通常为空，表示让系统来选择共享内存的地址。

shm_flg：是一组标志位，通常为0。

### shmdt

该函数用于将共享内存从当前进程中分离。注意，将共享内存分离并不是删除它，只是使该共享内存对当前进程不再可用

```c
int shmdt(const void *shmaddr);
```

shmaddr：shmat函数返回的地址指针，调用成功时返回0，失败时返回-1

### shmctl

用来控制共享内存

```c
int shmctl(int shmid, int cmd, struct shmid_ds *duf);
```

buf：一个结构指针，它指向共享内存模式和访问权限的结构。

## 多线程

多线程是为了使得多个线程并行的工作以完成多项任务,以提高系统的效率。线程是在同一时间需要完成多项任务的时候被实现的

线程是进程的一部分，一个没有线程的进程可以被看作是单线程的。线程有时又被称为轻权进程或轻量级进程，也是CPU调度的一个基本单位

线程存在5种基本操作来切换线程的状态：派生，阻塞，激活，调度，结束

进程是具有一定独立功能的程序关于某个数据集合上的一次运行活动,进程是系统进行资源分配和调度的一个独立单位

线程比进程的粒度更细，线程是进程执行流中的分支，拥有进程一部分资源

## 多进程和多线程的区别

多线程比多进程成本低，但性能更低

### 多进程的优点

1.每个进程互相独立，不影响主程序的稳定性，子进程崩溃没关系

2.通过增加CPU，就可以容易扩充性能

3.可以尽量减少线程加锁/解锁的影响，极大提高性能，就算是线程运行的模块算法效率低也没关系

4.每个子进程都有2GB地址空间和相关资源，总体能够达到的性能上限非常大

### 多线程的优点

1.无需跨进程边界

2.程序逻辑和控制方式简单

3.所有线程可以直接共享内存和变量等

4.线程方式消耗的总资源比进程方式好

## 在多进程和多线程之间的选择

1.多进程占用内存多，切换复杂，CPU利用率低	多线程占用内存少，切换简单，CPU利用率高

2.多进程创建销毁、切换复杂，速度慢	多线程创建销毁、切换简单，速度很快

3.多进程编程简单，调试简单	多线程编程复杂，调试复杂

4.多进程进程间不会互相影响	多线程一个线程挂掉将导致整个进程挂掉

优先考虑内存，cpu和操作时选择多线程

优先考虑编程，测试和可靠性时选择多进程



